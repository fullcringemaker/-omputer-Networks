<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Одноранговая Почтовая Служба</title>
</head>
<body>
    <h1>Одноранговая Почтовая Служба</h1>
    <div id="peersContainer"></div>

    <script>
        const peersContainer = document.getElementById('peersContainer');

        // Подключение к WebSocket
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws`);

        // Хранилище пиров и их сообщений
        const peers = {};

        ws.onopen = () => {
            console.log('WebSocket подключен');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const allReceivedMessages = data.allReceivedMessages;
            const peerInfo = data.peerInfo;

            // Обновляем локальное хранилище
            for (const [recipientPeerName, messages] of Object.entries(allReceivedMessages)) {
                if (!peers[recipientPeerName]) {
                    peers[recipientPeerName] = {
                        name: recipientPeerName,
                        ipPort: peerInfo[recipientPeerName] || "Unknown",
                        messages: []
                    };
                }
                // Обновляем список сообщений
                peers[recipientPeerName].messages = messages.map(msg => ({
                    sender: msg.sender,
                    content: msg.content
                }));

                // Обновляем ipPort, если он известен
                if (peers[recipientPeerName].ipPort === "Unknown" && peerInfo[recipientPeerName]) {
                    peers[recipientPeerName].ipPort = peerInfo[recipientPeerName];
                }
            }

            // Обновляем веб-интерфейс
            renderPeers();
        };

        ws.onclose = () => {
            console.log('WebSocket отключен');
        };

        ws.onerror = (error) => {
            console.error('WebSocket ошибка:', error);
        };

        // Функция для рендеринга пиров и сообщений
        function renderPeers() {
            peersContainer.innerHTML = ""; // Очистка контейнера

            for (const [peerName, peerData] of Object.entries(peers)) {
                const peerDiv = document.createElement('div');
                peerDiv.id = `peer-${peerName}`; // Уникальный ID для каждого пира

                // Название пира и его IP:порт
                const title = document.createElement('h2');
                title.textContent = `Пир: ${peerData.name} (${peerData.ipPort})`;
                peerDiv.appendChild(title);

                // Список сообщений
                const messagesList = document.createElement('ul');

                peerData.messages.forEach(msg => {
                    const messageItem = document.createElement('li');
                    messageItem.textContent = `От: ${msg.sender}\nСообщение: ${msg.content}`;
                    messagesList.appendChild(messageItem);
                });

                peerDiv.appendChild(messagesList);
                peersContainer.appendChild(peerDiv);
            }
        }
    </script>
</body>
</html>
