<!-- index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Одноранговая Почтовая Служба</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .peer {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px;
        }
        .peer h2 {
            margin-top: 0;
        }
        .message {
            background-color: #f9f9f9;
            border-left: 3px solid #007BFF;
            padding: 5px;
            margin: 5px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Одноранговая Почтовая Служба</h1>
    <div id="peersContainer"></div>

    <script>
        const peersContainer = document.getElementById('peersContainer');

        // Подключение к WebSocket
        const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws`);

        // Хранилище пиров и их сообщений
        const peers = {};

        // Хранилище информации о пирах
        const peerInfos = {};

        ws.onopen = () => {
            console.log('WebSocket подключен');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const allReceivedMessages = data.allReceivedMessages;
            const peerInfo = data.peerInfo;

            // Обновляем peerInfos
            for (const [peerName, ipPort] of Object.entries(peerInfo)) {
                peerInfos[peerName] = ipPort;
            }

            // Обновляем локальное хранилище
            for (const [recipientPeerName, messages] of Object.entries(allReceivedMessages)) {
                if (!peers[recipientPeerName]) {
                    peers[recipientPeerName] = {
                        name: recipientPeerName,
                        ipPort: peerInfos[recipientPeerName] || "Unknown",
                        messages: []
                    };
                }
                peers[recipientPeerName].messages = messages.map(msg => ({
                    sender: msg.sender,
                    content: msg.content,
                    timestamp: msg.timestamp,
                    senderIP: msg.senderIP,
                    senderPort: msg.senderPort
                }));
                // Обновляем ipPort, если он известен
                if (peers[recipientPeerName].ipPort === "Unknown" && peerInfos[recipientPeerName]) {
                    peers[recipientPeerName].ipPort = peerInfos[recipientPeerName];
                }
            }

            // Обновляем веб-интерфейс
            renderPeers();
        };

        ws.onclose = () => {
            console.log('WebSocket отключен');
        };

        ws.onerror = (error) => {
            console.error('WebSocket ошибка:', error);
        };

        // Функция для рендеринга пиров и сообщений
        function renderPeers() {
            peersContainer.innerHTML = ""; // Очистка контейнера

            for (const [peerName, peerData] of Object.entries(peers)) {
                const peerDiv = document.createElement('div');
                peerDiv.className = 'peer';

                const title = document.createElement('h2');
                title.textContent = `Пир: ${peerData.name} (${peerData.ipPort})`;
                peerDiv.appendChild(title);

                const messagesDiv = document.createElement('div');
                messagesDiv.className = 'messages';

                peerData.messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message';
                    const time = new Date(msg.timestamp * 1000).toLocaleString();
                    messageDiv.textContent = `От: ${msg.sender} (${msg.senderIP}:${msg.senderPort}) в ${time}\nСообщение: ${msg.content}`;
                    messagesDiv.appendChild(messageDiv);
                });

                peerDiv.appendChild(messagesDiv);
                peersContainer.appendChild(peerDiv);
            }
        }
    </script>
</body>
</html>
